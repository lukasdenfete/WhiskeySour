@using System.Security.Claims
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model WhiskeySour.Web.ViewModels.ForumViewModel

<div class="d-flex justify-content-end mb-3">
    <a asp-controller="Forum" asp-action="Index" class="btn btn-dark">
        Back to forum
    </a>
</div>
<h2>@Model.ThreadTitle</h2>
<p class="mb-2">
    <strong>Created by:</strong> @Model.CreatedByName on @Model.Created.ToString("yyyy-MM-dd HH:mm")
    @if (Model.IsEdited)
    {
        <span class="ms-2 text-muted">(Edited: @Model.EditedAt?.ToString("yyyy-MM-dd HH:mm"))</span>
    }
</p>
<p>@Model.ThreadContent</p>

@if (Model.ThreadImage != null)
{
    <img src="data:image/jpeg;base64,@Convert.ToBase64String(Model.ThreadImage)" class="img-fluid mb-3" style="max-height: 200px;" />
}

@if (User.FindFirstValue(ClaimTypes.NameIdentifier) == Model.CreatedById || User.IsInRole("Admin"))
{
    <div class="d-flex justify-content-end gap-2">
    <a asp-controller="Forum" asp-action="Edit" asp-route-id="@Model.ThreadId" class="btn btn-dark">Edit Thread</a>
    <form asp-action="DeleteThread" method="post" class="mt-0"
          onsubmit="return confirm('Are you sure you want to delete this thread?');">
        <input type="hidden" name="id" value="@Model.ThreadId"/>
        <button type="submit" class="btn btn-danger">Delete thread</button>
    </form>
    </div>
}


<h6>Comments</h6>
@if (Model.Comments != null && Model.Comments.Any())
{
    <ul class="list-group mb-4">
        @foreach (var comment in Model.Comments)
        {
            <li class="list-group-item">
                <div>
                <p>@comment.Content</p>
                @if (comment.Image != null)
                {
                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(comment.Image)" class="img-fluid mb-2" style="max-height: 200px;"/>
                }
                <div class="mt-2 d-flex align-items-center">
                    <span>@comment.Likes @((comment.Likes == 1) ? "like" : "likes")</span> @* om 1 == true Ã¤r det like, annars likes *@
                    <form asp-action="LikeComment" method="post">
                        <input type="hidden" name="commentId" value="@comment.CommentId"/>
                        <button type="submit" @(comment.HasLiked ? "disabled" : "")>Like</button>
                    </form>
                </div>
                
                
                <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">
                    By @comment.CreatedByName on @comment.Created.ToString("yyyy-MM-dd HH:mm")
                    @if (comment.IsEdited)
                    {
                        <span class="ms-2">(Edited: @comment.EditedAt?.ToString("yyyy-MM-dd HH:mm"))</span>
                    }
                </small>
                @if (comment.CreatedById == User.FindFirstValue(ClaimTypes.NameIdentifier) || User.IsInRole("Admin"))
                {
                    <div class="d-flex gap-2 mt-2">
                        <a asp-controller="Forum" asp-action="EditComment" asp-route-id="@comment.CommentId"
                           class="btn btn-outline-dark btn-sm me-2">Edit</a>
                        <form asp-controller="Forum" asp-action="DeleteComment" method="post" style="display:inline;"
                              onsubmit="return confirm('Are you sure you want to delete this comment?');">
                            <input type="hidden" name="id" value="@comment.CommentId"/>
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>

                        </form>
                    </div>
                }
                </div>
                </div>
            </li>
        }
    </ul>
}
else
{
    <p class="text-muted">Be the first to comment in this thread</p>
}

<form asp-action="AddComment" method="post" enctype="multipart/form-data">
    <input type="hidden" name="ThreadId" value="@Model.ThreadId"/>
    <div class="form-group">
        <label for="Content">Add comment:</label>
        <textarea name="Content" class="form-control" rows="3"></textarea>
        <span asp-validation-for="NewComment.Content" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label for="ImageFile">Add image to your comment (optional)</label>
        <input type="file" name="ImageFile" class="form-control"/>
    </div>
    <button type="submit" class="btn btn-dark mt-2">Post Comment </button>
</form>


@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}