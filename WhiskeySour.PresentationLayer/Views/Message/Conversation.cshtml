@using System.Security.Claims

@model List<WhiskeySour.Web.ViewModels.MessageViewModel>

@{
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var partnerName = ViewBag.PartnerName as string ?? "Unknown";
    ViewData["Title"] = $"Conversation with {partnerName}";
}

<h2>@ViewData["Title"]</h2>

<div class="mb-3">
    @foreach (var message in Model)
    {
<<<<<<< Updated upstream
        <div class="p-2 mb-1 @(message.IsMine ? "bg-light text-end" : "bg-secondary text-white text-start rounded")">
            <strong>@(message.IsMine ? "Me" : message.SenderName)</strong>: @message.Content
=======
        <div class="p-2 mb-1 @(message.IsMine ? "bg-light text-end" : "bg-light text-start rounded")">
            @if (message.SenderProfileImage != null)
            {
                var base64 = Convert.ToBase64String(message.SenderProfileImage);
                var imgSrc = $"data:image/png;base64,{base64}";
                <img src="@imgSrc" alt="profile picture" class="rounded-circle" style="width: 32px; height: 32px;"/>
            }
            <strong>
                @if (message.IsMine)
                {
                    <span>Me</span>
                }
                else
                {
                    <a asp-controller="Profile" asp-action="Details" asp-route-id="@message.SenderId" class="text-decoration-none text-dark">
                        @message.SenderName
                    </a>
                }
            </strong>
            : @message.Content
            
>>>>>>> Stashed changes
            <br/>
            <small class="text-muted">@message.SentAt.ToString("yyyy-MM-dd HH:mm")
            @if (message.IsMine)
            {
                if (message.IsRead)
                {
                    <span class="ms-2 text-success">✓ Read</span>
                }
                else
                {
                    <span class="ms-2 text-muted">✓ Sent</span>
                }
            }
                </small>
        </div>
    }
</div>
<form asp-controller="Message" asp-action="Send" method="post">
    <input type="hidden" name="receiverId" value="@ViewBag.PartnerId" />
    <div class="input-group">
        <textarea name="content" class="form-control" rows="2" placeholder="Write a message.."></textarea>
        <button type="submit" class="btn btn-dark ms-2">Send</button>
    </div>
</form>
