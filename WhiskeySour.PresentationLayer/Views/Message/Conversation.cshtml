@using System.Security.Claims
@using NuGet.Protocol.Plugins

@model List<WhiskeySour.Web.ViewModels.MessageViewModel>

@{
    ViewData["Title"] = "Conversation";
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<h2>Conversation</h2>

<div class="mb-3">
    @foreach (var message in Model)
    {
        <div class="p-2 mb-1 @(message.IsMine ? "bg-light text-end" : "bg-light text-start rounded")">
            @if (message.SenderProfileImage != null)
            {
                var base64 = Convert.ToBase64String(message.SenderProfileImage);
                var imgSrc = $"data:image/png;base64,{base64}";
                <img src="@imgSrc" alt="profile picture" class="rounded-circle" style="width: 32px; height: 32px;"/>
            }
            <strong>@(message.IsMine ? "Me" : message.SenderName)</strong>: @message.Content
            <br/>
            <small class="text-muted">@message.SentAt.ToString("yyyy-MM-dd HH:mm")
                @if (message.IsMine)
                {
                    if (message.IsRead)
                    {
                        <span class="ms-2 text-success">✓ Read</span>
                    }
                    else
                    {
                        <span class="ms-2 text-muted">✓ Sent</span>
                    }
                }
            </small>
        </div>
    }
</div>
<form asp-controller="Message" asp-action="Send" method="post">
    <input type="hidden" name="receiverId" value="@ViewBag.PartnerId" />
    <div class="input-group">
        <textarea name="content" class="form-control" rows="2" placeholder="Write a message.."></textarea>
        <button type="submit" class="btn btn-dark ms-2">Send</button>
    </div>
</form>